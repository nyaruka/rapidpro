-extends 'smartmin/form.html'
-load smartmin temba compress i18n

-block pre-form
  -if not two_factor_enabled
    .mb-4
      -blocktrans trimmed with ga_url="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" authy_url="https://authy.com/"
        To enable two factor authentication, use a one-time password (OTP) application such as <a href="{{ ga_url }}">Google Authenticator</a>
        or <a href="{{ authy_url }}">Authy</a> to scan the QR code below and generate an OTP.

    %canvas#qr
    %br
    %script(src="{{ STATIC_URL }}js/qrious.js")

    :javascript
      (function() {
        var secretUrl = "{{ secret_url }}";
        if (secretUrl) {
          var element = document.getElementById('qr');
          element.style.display = "initial";
          new QRious({element: element, value: secretUrl, background: "#eee", size: 128});
        }
      })();
    

-block fields
  -if not two_factor_enabled
    .mt-4
      {{ block.super }}
  -else
    -blocktrans trimmed
      Backup tokens can be used if you no longer have access to the authentication application configured for
      your account.

    .mt-4
      %p#backup_text_help.hide
        -blocktrans trimmed
          Any tokens you may have previously generated are invalid.

    .mt-4
      #backup.font-mono
        -for token in backup_tokens
          .inline-block.px-2(class="{% if token.is_used %}line-through{% endif %}")
            {{ token.token }}

    .mt-8
      %a#disable-2fa.button-primary.mr-4(href="{% url 'orgs.org_home' %}")
        -trans "Disable"
      %a#regenerate-backup-tokens.button-light.mr-4
        -trans "Regenerate Backup Tokens"

    -url 'orgs.org_two_factor' as two_factor_url
    :javascript
      $('#disable-2fa').click(function() {
        $.ajax({type: "POST", url: "{{ two_factor_url }}", data: {"action": "disable"}})
      });

      $('#regenerate-backup-tokens').click(function() {
        $.ajax({
          type: "POST",
          url: "{{ two_factor_url }}",
          data: {"action": "regenerate_backup_tokens"},
          success: function( backups ) {
            var tokenHtml = '';
            for (token of backups.tokens) {
                tokenHtml = tokenHtml + `<div class="inline-block px-2 ${token.is_used ? 'line-through' : ''}">${token.token}</div>`;
            }
            $('#backup').html(tokenHtml);
            $("#backup_text_help").show();
          }
        })
      });


-block form-buttons
  -if not two_factor_enabled
    {{ block.super }}

-block summary
  -if two_factor_enabled
    -blocktrans trimmed
      Two Factor Authentication is <b>enabled</b>.
  -else
    -blocktrans trimmed
      Two Factor Authentication is <b>disabled</b>.
